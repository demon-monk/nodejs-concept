## Performance

- ä½¿ç”¨Nodeçš„Cluster Mode ï¼ˆRecommendï¼‰
- ä½¿ç”¨Worker Thread ï¼ˆExperimentalï¼‰

### Cluster Mode

#### Why

`Event Loop`æ˜¯å•çº¿ç¨‹çš„ã€‚å•çº¿ç¨‹å°±ä¼šæœ‰äº›é—®é¢˜

```js
const express = require("express");
const app = express();
function doWork(duration) {
  const startTime = Date.now();
  while (Date.now() - startTime < duration) {}
}
app.get("/", (req, res) => {
  doWork(5000);
  res.send("Hi there!");
});
app.listen(3000);
```

ä¸Šé¢çš„ä»£ç ä¸­ã€‚æ¯ä¸ªè¯·æ±‚è¦5såæ‰èƒ½è¿”å›ã€‚å¦‚æœåŒæ—¶æœ‰nä¸ªè¯·æ±‚ï¼Œæœ€åä¸€ä¸ªè¯·æ±‚å¯èƒ½éœ€è¦`n*5`sæ‰èƒ½æ”¶åˆ°è¿”å›ã€‚å› ä¸º`doWork`çš„ä»£ç ä¼šé˜»å¡`Event Loop`çš„çº¿ç¨‹

#### éCluster Mode

![](https://ws2.sinaimg.cn/large/006tNc79gy1fzmdwhvrcfj305608k74r.jpg)

è¯»å–è„šæœ¬ï¼Œåˆ›å»ºNodeå®ä¾‹ã€‚Easyï¼

#### Cluster Mode

![](https://ws4.sinaimg.cn/large/006tNc79gy1fzme6su7lwj30c30a875s.jpg)

- è¯»å–è„šæœ¬ï¼Œåˆ›å»ºNodeå®ä¾‹ã€‚åªä¸è¿‡æœ€å…ˆåˆ›å»ºçš„è¿™ä¸ªå®ä¾‹ï¼Œæˆ‘ä»¬é€šå¸¸ç§°ä¹‹ä¸ºCluster Managerã€‚ 
- Cluster Managerä¸æ‰§è¡Œä¸šåŠ¡ä»£ç ï¼Œåªæ˜¯ç”¨æ¥åˆ›å»ºå’Œç®¡ç†Nodeçš„Workerå®ä¾‹ã€‚åè€…æ‰æ‰§è¡Œä¸šåŠ¡ä»£ç ã€‚
- åˆ›å»ºWorkerå®ä¾‹éœ€è¦ç”¨åˆ°`cluster`æ¨¡å—ä¸­çš„`fork()`æ–¹æ³•ã€‚æ¯å½“æ‰§è¡Œåˆ°`fork`æ–¹æ³•ï¼ŒCluster Managerå°±ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„Workerå®ä¾‹ã€‚
- æ€»çš„æ¥è¯´ï¼Œè„šæœ¬å°†ä¼šè¢«æ‰§è¡Œå¤šæ¬¡ã€‚ç¬¬ä¸€æ¬¡ç”¨äºåˆ›å»ºCluster Managerï¼Œåé¢ç”¨äºåˆ›å»ºWorkerå®ä¾‹ã€‚

å¯ä»¥é€šè¿‡ä»¥ä¸‹ä»£ç æ¥åˆ¤æ–­å½“å‰å®ä¾‹æ˜¯Cluster Managerè¿˜æ˜¯Workerã€‚

```js
const cluster = require('cluster')
console.log(cluster.isMaster) // true for Cluster Manager, false for Worker
```

Cluster Modeä¸‹çš„ç¼–ç patternå¤§æ¦‚å¯ä»¥æè¿°æˆè¿™ä¸ªæ ·å­

```js
if (cluster.isMaster) {
    // in Cluster Manager instance, then create a new Worker instance, and run this script again
    cluster.fork()
    cluster.fork()
} else {
    // code that will be ran in Worker instance
    // the same with the first code snippet above
}
```

åœ¨ä¸¤ä¸ªæµè§ˆå™¨tabä¸­åŒæ—¶è®¿é—®`localhost:3000`ï¼Œä¸¤ä¸ªè¯·æ±‚éƒ½æ˜¯5såè¿”å›ï¼Œä¹Ÿå°±æ˜¯ç¬¬ä¸€ä¸ªè¯·æ±‚ä¸ä¼šé˜»å¡åä¸€ä¸ªã€‚å› ä¸ºç°åœ¨æœ‰ä¸¤ä¸ªNodeå®ä¾‹åœ¨å¤„ç†è¯·æ±‚ã€‚

#### åˆ«æ»¥ç”¨fork

æ»¥ç”¨forkæœ‰å¯èƒ½ä½¿ä½ çš„æœ€å¿«responseæ—¶é—´å˜å¾—æ›´é•¿ã€‚é€šå¸¸å‡†åˆ™æ˜¯ä½¿workerå®ä¾‹çš„ä¸ªæ•°ç­‰äºCPUçš„æ ¸ç†Ÿã€‚

#### PM2 ç®¡ç†Cluster

ğŸ‘†ä½¿ç”¨Clusterçš„ä»£ç å…¶å®è¿˜å¾ˆä¸å®Œå–„ã€‚è¿˜éœ€è¦åœ¨Masterå®ä¾‹ä¸­æ·»åŠ æ£€æµ‹Workerå®ä¾‹çš„å¥åº·çŠ¶å†µï¼Œcrashè‡ªåŠ¨é‡å¯ç­‰åŠŸèƒ½ã€‚

ä¸è¿‡æˆ‘ä»¬å¯ä»¥ä½¿ç”¨PM2æ¥ä½¿ç”¨è¿™äº›åŠŸèƒ½ã€‚

```sh
yarn add pm2 -D
```

```sh
yarn pm2 start script.js -i 0 # 0 means worker instances count equals to logic cores' of this machine
```

```sh
yarn pm2 list
```

```sh
yarn pm2 delete instance-name
```

```sh
yarn pm2 monit
```

æ›´å¤šä¿¡æ¯æŸ¥çœ‹[å®˜ç½‘](http://pm2.keymetrics.io/)

### Worker Thread

![](https://ws3.sinaimg.cn/large/006tNc79gy1fzmjl0woe9j30am0apta7.jpg)

[More Info](https://www.npmjs.com/package/webworker-threads)

